<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Customize - Anoma Docs</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../assets/custom.css">
        <link rel="stylesheet" href="../../assets/mdbook-admonish.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../quick-start.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="../../user-guide/index.html"><strong aria-hidden="true">3.</strong> User Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../user-guide/install.html"><strong aria-hidden="true">3.1.</strong> Install</a></li><li class="chapter-item expanded "><a href="../../user-guide/getting-started.html"><strong aria-hidden="true">3.2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../../user-guide/wallet.html"><strong aria-hidden="true">3.3.</strong> The Wallet</a></li><li class="chapter-item expanded "><a href="../../user-guide/ledger.html"><strong aria-hidden="true">3.4.</strong> The Ledger</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../user-guide/ledger/pos.html"><strong aria-hidden="true">3.4.1.</strong> Interact with PoS</a></li><li class="chapter-item expanded "><a href="../../user-guide/ledger/customize.html" class="active"><strong aria-hidden="true">3.4.2.</strong> Customize</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../testnets/index.html"><strong aria-hidden="true">4.</strong> Testnets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../testnets/internal-testnet-1.html"><strong aria-hidden="true">4.1.</strong> Internal Testnet 1</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Anoma Docs</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/anoma/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/anoma/docs/edit/master/src/user-guide/ledger/customize.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="customize-accounts-and-transactions"><a class="header" href="#customize-accounts-and-transactions">Customize accounts and transactions</a></h1>
<p>On this page, we'll cover how to tailor your account(s) to your use-case with custom-made validity predicates and transactions.</p>
<p>We currently only support Rust for custom validity predicates and transactions via WASM, but expect many more options to be available in the future!</p>
<h2 id="-anoma-accounts-primer"><a class="header" href="#-anoma-accounts-primer">👩🏽‍🏫 Anoma accounts primer</a></h2>
<p>Instead of the common smart contract design, in Anoma, all the accounts follow the same basic principles. Each account has exactly one validity predicate. Any transaction that attempts to make some storage modifications will trigger validity predicates of each account whose storage has been modified by it. Validity predicates are stateless functions that decide if an account accepts the transaction.</p>
<p>Every account also has its dedicated key-value storage. The ledger encodes agnostic, it allows you to use the encoding of your preference for the storage values. Internally and for the pre-built validity predicates and transactions, we use <a href="https://github.com/near/borsh-rs">Borsh</a>, which allows you to simply derive the encoding from your data types. The storage keys are <code>/</code> separated path segments, where the first segment is always the address of the account to which the storage key belongs. In storage keys, addresses use a reserved prefix <code>#</code>.</p>
<p>To illustrate with an example storage key used for fungible tokens (with addresses shortened for clarity), let's say:</p>
<ul>
<li>
<p>XAN token's address is <code>atest1v4ehgw36x3prs...</code></p>
</li>
<li>
<p>A user Bertha has address <code>atest1v4ehgw36xvcyyv...</code></p>
</li>
<li>
<p>Then, the balance of Bertha's XAN tokens is stored in the XAN account, with the storage key comprised of <code>#{token}/balance/#{owner}</code>, i.e.:</p>
<pre><code class="language-text">#atest1v4ehgw36x3prs.../balance/#atest1v4ehgw36xvcyy...
</code></pre>
</li>
</ul>
<p>Any transaction can attempt to make changes to the storage of any account(s). Only if all the involved accounts accept, the transaction will it be committed. Otherwise, the transaction is rejected and its modifications discarded.</p>
<p>This approach allows multiparty transactions to be applied atomically, without any a priority coordination. It also gives accounts complete and fine-grained control over how they can be used in transactions in themselves and in relation to other accounts.</p>
<p>In fact, most of the functionality in the Anoma ledger is being built leveraging the simplicity and flexibility of this account system, from a simple fungible token to more complex accounts that integrate the Inter-blockchain Communication protocol and the Proof of Stake system.</p>
<h2 id="-validity-predicates"><a class="header" href="#-validity-predicates">☑ Validity predicates</a></h2>
<p>A custom validity predicates can be built from scratch using <code>vp_template</code> (from root directory <a href="https://github.com/anoma/anoma/tree/v0.5.0/wasm/vp_template"><code>wasm/vp_template</code></a>), which is Rust code compiled to WASM. Consult its <code>README.md</code> to find out more.</p>
<p>You can also check out the pre-built validity predicates' source code in the <a href="https://github.com/anoma/anoma/tree/v0.5.0/wasm/wasm_source"><code>wasm/wasm_source</code></a>, where each sub-module that begins with <code>vp_</code> implements a validity predicate. For example the <a href="https://github.com/anoma/anoma/blob/v0.5.0/wasm/wasm_source/src/vp_user.rs"><code>vp_user</code></a> is the default validity predicate used for established accounts (created with <code>init-account</code> command).</p>
<p>A validity predicate's must contain the following function:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use anoma_vm_env::vp_prelude::*;

#[validity_predicate]
fn validate_tx(
    // The data attached to the transaction
    tx_data: Vec&lt;u8&gt;,
    // The address of the account where this validity predicate is used
    addr: Address,
    // The storage keys that were modified by the transaction
    keys_changed: BTreeSet&lt;storage::Key&gt;,
    // The addresses of all the accounts that are verifying the current 
    // transaction
    verifiers: BTreeSet&lt;Address&gt;,
) -&gt; bool {
  // Returning `true` allows any key change
  true
}
<span class="boring">}
</span></code></pre></pre>
<p>You can think of it as its <code>main</code> function. When this VP is deployed to an account, this function will be called for every transaction that:</p>
<ul>
<li>Modifies a storage key that contains the account's address to which the validity predicate belongs</li>
<li>Inserts the account's address into the verifier set with <a href="https://docs.anoma.net/v0.5.0/rustdoc/anoma_vm_env/imports/tx/fn.insert_verifier.html"><code>tx_prelude::insert_verifiers</code> function</a></li>
</ul>
<p>Inside the validity predicate function, you can read any storage value with the functions provided in the <code>vp_prelude</code> from the storage prior to the transaction (functions with name suffix <code>_pre</code>) and from the storage state after the transaction is applied (suffixed with <code>_post</code>).</p>
<p>To find out about the host interface available in a validity predicate, please check out <a href="https://docs.anoma.net/v0.5.0/rustdoc/anoma_vm_env/vp_prelude/index.html">Rust docs for <code>vp_prelude</code></a>.</p>
<p>To compile the validity predicate's code from the template:</p>
<pre><code class="language-shell">make -C wasm/vp_template
</code></pre>
<p>This will output a WASM file that can be found in <code>wasm/vp_template/target/wasm32-unknown-unknown/release/vp_template.wasm</code>.</p>
<p>You can, for example, copy it into your <code>wasm</code> directory (the default directory used by the ledger's node and the client, which can be changed with <code>--wasm-dir</code> global argument or <code>ANOMA_WASM_DIR</code>):</p>
<pre><code class="language-shell">cp \
  wasm/vp_template/target/wasm32-unknown-unknown/release/vp_template.wasm \
  wasm/my_vp.wasm
</code></pre>
<p>To submit a transaction that updates an account's validity predicate:</p>
<pre><code class="language-shell">anoma client update --address my-new-acc --code-path my_vp.wasm
</code></pre>
<h2 id="-custom-transactions"><a class="header" href="#-custom-transactions">📩 Custom transactions</a></h2>
<p>A transaction must contain a WASM code that can perform arbitrary storage changes. It can also contain arbitrary data, which will be passed onto the transaction and validity predicates when the transaction is being applied.</p>
<p>A custom transaction can be built from scratch using <code>tx_template</code> (from root directory <a href="https://github.com/anoma/anoma/tree/v0.5.0/wasm/tx_template"><code>wasm/tx_template</code></a>), which is Rust code compiled to WASM. Consult its <code>README.md</code> to find out more.</p>
<p>For some inspiration, check out the pre-built transactions source code in the <a href="https://github.com/anoma/anoma/tree/v0.5.0/wasm/wasm_source"><code>wasm/wasm_source</code></a>, where each sub-module that begins with <code>tx_</code> implements a transaction.</p>
<p>A transaction code must contain the following function, which will be called when the transaction is being applied:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use anoma_vm_env::tx_prelude::*;

#[transaction]
fn apply_tx(tx_data: Vec&lt;u8&gt;) {
  // Do anything here
}
<span class="boring">}
</span></code></pre></pre>
<p>Inside the validity predicate function, you can read, write or delete any storage value with the functions provided in the <code>tx_prelude</code> from the storage of any account.</p>
<p>To find out about the interface available in a transaction, please check out <a href="https://docs.anoma.net/v0.5.0/rustdoc/anoma_vm_env/tx_prelude/index.html">Rust docs for <code>tx_prelude</code></a>.</p>
<p>Compile the transaction's code from the template:</p>
<pre><code class="language-shell">make -C wasm/tx_template
</code></pre>
<p>This will output a WASM file that can be found in <code>wasm/tx_template/target/wasm32-unknown-unknown/release/tx_template.wasm</code>.</p>
<p>Submit the transaction to the ledger:</p>
<pre><code class="language-shell">anoma client tx --code-path tx_template/tx.wasm
</code></pre>
<p>Optionally, you can also attach some data to the transaction from a file with the <code>--data-path</code> argument.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/anoma/docs/edit/main/src/user-guide/ledger/customize.md">Edit this file on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../user-guide/ledger/pos.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../testnets/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../user-guide/ledger/pos.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../testnets/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
